version: 2.1

orbs:
  aws-ecr: circleci/aws-ecr@9.5.4

jobs:
  build-and-test:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      # Enable Docker support
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker image
          command: |
            docker build -t arxiv-explorer:latest .
      - run:
          name: Test Docker image
          command: |
            # Start the container with environment variables
            docker run -d --name test-container \
              -p 8080:8080 \
              -e TAVILY_API_KEY="${TAVILY_API_KEY}" \
              -e AWS_REGION="${AWS_DEFAULT_REGION:-us-east-1}" \
              arxiv-explorer:latest
            
            # Wait for container to start
            sleep 15
            
            # Check if container is running and hasn't exited
            #docker ps | grep test-container || exit 1
            
            # Clean up
            docker stop test-container
            docker rm test-container

  deploy-to-ecr:
    docker:
      - image: cimg/aws:2023.06
    steps:
      - checkout
      # Enable Docker support
      - setup_remote_docker:
          docker_layer_caching: true
      # Login to ECR
      - aws-ecr/ecr_login:
          region: "${AWS_DEFAULT_REGION}"
          account_id: "${AWS_ACCOUNT_ID}"
      # Build and tag the image
      - run:
          name: Build and tag Docker image
          command: |
            docker build -t arxiv-explorer:latest .
            docker tag arxiv-explorer:latest ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/arxiv-explorer:latest
            docker tag arxiv-explorer:latest ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/arxiv-explorer:${CIRCLE_SHA1}
      # Push the image
      - run:
          name: Push image to ECR
          command: |
            docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/arxiv-explorer:latest
            docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/arxiv-explorer:${CIRCLE_SHA1}

workflows:
  build-deploy:
    jobs:
      - build-and-test
      - deploy-to-ecr:
          requires:
            - build-and-test
          filters:
            branches:
              only: main